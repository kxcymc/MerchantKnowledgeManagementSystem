# Node.js后端开发指南（商家知识管理系统与问答机器人）

已完成： 阶段一 阶段二 。
已完成的阶段删除了步骤描述，只保留标题。

## 阶段一：项目初始化与环境配置

**步骤1：项目结构搭建**

**步骤2：依赖安装**

**步骤3：环境变量配置**

**步骤4：TypeScript编译配置**

---

## 阶段二：本地数据层搭建

**步骤5：SQLite数据库初始化**

**步骤6：向量数据库初始化**

**步骤7：知识库扫描服务**

---

## 阶段三：文档处理与向量化流水线

**步骤8：文本智能分块**

- 工具：自定义算法（按双换行符`\n\n`分割段落）
- 任务：将每篇PDF文本切分为约400字符的块，块间保留50字符重叠，过滤空块和短块
- 输出：结构化文本块数组，确保语义完整性和检索粒度平衡

**步骤9：Embedding模型调用**

- 工具：阿里 Multimodal-Embedding API（multimodal-embedding-v1）
- 任务：将文本块批量发送至API，每次请求不超过100条，接收1024维向量
- 输出：与文本块一一对应的浮点数向量数组

**步骤10：向量数据持久化**

- 工具：ChromaDB集合的`add`方法
- 任务：将向量、文本块、元数据（文件路径、分类）批量写入向量库，ID格式为`文件路径#块序号`
- 输出：可持久检索的向量化知识库

**步骤11：元数据记录**

- 工具：`better-sqlite3`的`INSERT OR REPLACE`语句
- 任务：在SQLite中记录每篇PDF的处理状态（active）、分类、块数量、文件修改时间
- 输出：知识管理列表所需的数据源

---

## 阶段四：RAG检索增强实现

**步骤12：用户问题向量化**

- 工具：同步骤9的Embedding API
- 任务：将用户输入的问答问题转换为向量表示
- 输出：问题向量，用于后续相似度匹配

**步骤13：向量相似度检索**

- 工具：ChromaDB集合的`query`方法
- 任务：设置`n_results=5`、`score_threshold=0.75`，返回最相似的文本块
- 输出：初步候选文档列表（含内容、来源ID、相似度分数）

**步骤14：关键词补充检索（可选优化）**

- 工具：`fuse.js`轻量级模糊搜索库或SQLite的`LIKE`查询
- 任务：对用户问题做关键词提取，在SQLite中全文模糊匹配，补充召回
- 输出：额外的候选文档，防止向量检索遗漏

**步骤15：结果重排序**

- 工具：Cross-Encoder模型（云端API或本地Python服务）
- 任务：将问题与候选文档逐一配对，计算相关性得分，重新排序
- 输出：按质量排好序的Top-3文档

---

## 阶段五：LLM对话生成

**步骤16：Prompt工程**

- 工具：字符串模板
- 任务：构建System Prompt，明确角色（抖音电商助手）、限制回答范围、要求结构化输出、强制引用来源；将Top-3文档作为Context嵌入
- 输出：符合RAG范式的完整Prompt字符串

**步骤17：LLM流式调用**

- 工具：DeepSeek或Volcengine Ark的HTTP API、`fetch`函数
- 任务：发送POST请求到`/chat/completions`接口，配置`stream: true`，逐字接收`data: {...}`响应块
- 输出：可读的流式数据，供前端实时展示

**步骤18：对话历史管理**

- 工具：`better-sqlite3`
- 任务：在生成答案的同时（异步），将用户问题和AI回答存入`messages`表，关联`conversationId`
- 输出：持久化的多轮对话记录

**步骤19：会话标题生成**

- 工具：LLM单次调用
- 任务：每当新会话第一条消息完成后，调用LLM用5个字概括问题，更新`conversations`表的标题字段
- 输出：清晰的会话列表展示

---

## 阶段六：API服务暴露

**步骤20：知识管理API**

- 工具：`express.Router`
- 任务：创建`GET /api/knowledge`返回知识列表（含状态、分类），`POST /api/knowledge/scan`触发手动扫描，`DELETE /api/knowledge/:id`删除知识
- 输出：前端知识管理界面所需的数据接口

**步骤21：聊天API（流式）**

- 工具：Express的`res.write`和`res.setHeader('Content-Type', 'text/event-stream')`
- 任务：创建`POST /api/chat`接口，接收`question`和`conversationId`，实现步骤12-18的完整RAG链路，通过Server-Sent Events推送token和来源信息
- 输出：前端聊天组件的实时数据流

**步骤22：会话历史API**

- 工具：`express.Router`
- 任务：创建`GET /api/conversations`返回会话列表，`GET /api/conversations/:id/messages`返回某会话的完整历史
- 输出：前端左侧会话栏的数据源

**步骤23：CORS配置**

- 工具：`cors` npm包
- 任务：在Express中配置`origin: http://localhost:3000`，允许前端跨域请求
- 输出：前后端联调无障碍

---

## 阶段七：开发工具与调试

**步骤24：扫描脚本**

- 工具：`tsx src/scripts/scan.ts`独立脚本
- 任务：可手动执行，重新扫描`PDFdatabase`文件夹，支持增量更新（比对文件修改时间）
- 输出：命令行反馈扫描进度和结果统计

**步骤25：对话测试脚本**

- 工具：`tsx src/scripts/test-chat.ts`独立脚本
- 任务：在终端输入问题，直接调用`/api/chat`接口，观察流式输出和引用来源
- 输出：快速验证后端逻辑，无需前端界面

**步骤26：向量效果验证**

- 工具：自定义测试用例（如"抖音小店怎么开通" vs "如何入驻抖音电商平台？"）
- 任务：计算两个问题向量的余弦相似度，验证是否大于0.8
- 输出：量化评估Embedding模型中文效果

---

## 阶段八：工程化与优化

**步骤27：npm脚本封装**

- 工具：package.json的`scripts`字段
- 任务：定义`npm run dev`（启动服务）、`npm run scan`（执行扫描）、`npm run test-chat`（测试对话）、`npm run init:db`（初始化数据库）
- 输出：一键操作，提升开发效率

**步骤28：日志记录**

- 工具：`pino`或`winston`日志库
- 任务：在PDF处理、向量检索、LLM调用等关键节点记录INFO级别日志，异常捕获记录ERROR日志
- 输出：可追踪的问题排查能力

**步骤29：错误处理机制**

- 工具：Express全局错误中间件
- 任务：统一捕获业务异常，返回`{code: 500, message: '...', traceId: '...'}`格式，避免服务崩溃
- 输出：健壮的API服务

**步骤30：性能基准测试**

- 工具：`autocannon`或`wrk`压力测试工具
- 任务：模拟10个并发请求调用`/api/chat`，统计平均响应时间和成功率
- 输出：确认本地环境性能是否满足基本体验要求（首Token响应<2秒）

---

## 阶段九：本地运行与交付

**步骤31：数据重置机制**

- 工具：`npm run reset`脚本
- 任务：删除`src/data/sqlite.db`和`src/data/chroma/`文件夹，重新执行扫描
- 输出：开发过程中可随时清理脏数据，重新来过

**步骤32：依赖清单确认**

- 工具：`npm list --depth=0`
- 任务：确认所有依赖已安装，版本锁定在package.json
- 输出：可复现的运行环境

**步骤33：端口约定**

- 工具：硬编码或环境变量`PORT=3001`
- 任务：后端服务固定监听3001端口，前端通过`http://localhost:3001/api`访问
- 输出：前后端联调标准地址

**步骤34：最终启动流程**

- 任务：新开发者只需执行`cd backend && npm i && npm run dev`
- 输出：服务启动后自动扫描PDF，生成数据库，等待前端连接

---

## 技术栈清单（不含Node.js）

| 类别 | 技术/工具 | 用途 |
|------|-----------|------|
| Web框架 | Express + TypeScript | API服务 |
| 业务数据库 | better-sqlite3 | 元数据与对话历史存储 |
| 向量数据库 | ChromaDB | 向量检索 |
| Embedding模型 | OpenAI text-embedding-3-small 或 阿里DashScope text-embedding-v3 | 文本向量化 |
| LLM模型 | DeepSeek-Chat 或 Volcengine Ark（豆包） | 答案生成 |
| PDF解析 | pdf-parse | 提取文本内容 |
| 分词/关键词 | fuse.js 或 SQLite LIKE | 补充检索 |
| 流式传输 | Server-Sent Events (SSE) | 实时推送答案 |
| 脚本运行 | tsx | 免编译执行TypeScript |
| 日志 | pino | 记录运行状态 |
| 测试 | autocannon | 性能压测 |
